"use client";

import { formatDistanceToNow } from "date-fns";
import { useState, Suspense } from "react";
import { CardContent, Card } from "@/components/ui/card";
import { ErrorBoundary } from "react-error-boundary";
import { useMqtt } from "@/lib/mqtt";

export const SensorCard = ({
  nodeID,
  reportedAt,
  currentValue,
  setID,

  sensorType,
  sensorUnit,
}: {
  nodeID: string;
  reportedAt: string;
  currentValue: number;
  setID: string;

  sensorType: string;
  sensorUnit: string;
}) => {
  const [value, setValue] = useState(currentValue);
  const [reportedTime, setReportedTime] = useState(reportedAt);

  let icon;
  switch (sensorType) {
    case "temperature":
      icon = <ThermometerIcon />;
      break;
    case "co2":
      icon = <CloudDrizzleIcon />;
      break;
    case "cWater":
      icon = <ColdWaterIcon />;
      break;
    case "wWater":
      icon = <WarmWaterIcon />;
      break;
    default:
      icon = <div></div>;
  }

  const onMessage = (topic: any, message: any) => {
    const { iotnode } = JSON.parse(message.toString());

    const reportedAt = iotnode.reportedAt;

    const sensorValue = iotnode[sensorType];
    console.log(`update ${sensorType}: ${sensorValue}`);

    setValue(sensorValue);
    setReportedTime(reportedAt);
  };

  useMqtt(setID, nodeID, onMessage);

  console.log(reportedTime);
  const formattedReportedTime = formatDistanceToNow(new Date(reportedTime), {
    addSuffix: true,
  });

  return (
    <ErrorBoundary fallback={<div></div>}>
      <Card className="w-80 rounded-2xl pt-4 flex items-center bg-muted justify-center">
        <CardContent className="">
          <div className="flex flex-row items-center justify-center  gap-8">
            {icon}
            <div className="grid gap-4">
              <div className="text-2xl font-bold tracking-tighter">
                {value} {sensorUnit}
              </div>
              <Suspense
                fallback={
                  <div className="text-xs font-light leading-none">
                    Loading...
                  </div>
                }
              >
                <div className="text-xs font-light leading-none">
                  {formattedReportedTime}
                </div>
              </Suspense>
            </div>
          </div>
        </CardContent>
      </Card>
    </ErrorBoundary>
  );
};

function ThermometerIcon() {
  return (
    <div className="h-[96px] flex items-center">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="4em"
        height="4em"
        viewBox="0 0 56 56"
      >
        <path
          fill="currentColor"
          d="M27.192 8.304c1 0 1.826-.826 1.826-1.804V1.805c0-1-.826-1.805-1.826-1.805c-.978 0-1.805.805-1.805 1.804V6.5c0 .978.827 1.804 1.805 1.804M37.235 12.5c.674.696 1.87.717 2.587 0l3.305-3.348a1.81 1.81 0 0 0 0-2.543a1.784 1.784 0 0 0-2.522 0l-3.37 3.37c-.695.695-.674 1.826 0 2.521M16.844 56c6.26 0 11.348-5.087 11.348-11.348c0-3.304-1.37-6.195-3.957-8.543c-.478-.435-.587-.674-.587-1.326l.022-2.087c1.109.413 2.304.608 3.522.608c5.978 0 10.76-4.782 10.76-10.76a10.735 10.735 0 0 0-10.76-10.783c-1.348 0-2.652.26-3.892.76c-.89-2.977-3.26-4.825-6.456-4.825c-4.109 0-6.87 3.021-6.87 7.565l.022 19.522c0 .652-.109.891-.565 1.326c-2.609 2.348-3.956 5.239-3.956 8.543C5.475 50.913 10.54 56 16.844 56m0-3.152c-4.522 0-8.196-3.696-8.196-8.196c0-2.717 1.283-5.174 3.587-6.717c.674-.457.935-.87.935-1.761V15.391c0-2.739 1.5-4.5 3.674-4.5c2.152 0 3.63 1.761 3.63 4.5v20.783c0 .891.261 1.304.935 1.76c2.305 1.544 3.587 4 3.587 6.718c0 4.5-3.652 8.196-8.152 8.196m10.348-37.913c4.26 0 7.565 3.326 7.565 7.609c0 4.26-3.304 7.587-7.565 7.587a7.559 7.559 0 0 1-3.522-.892l.022-13.348c1.065-.608 2.26-.956 3.5-.956m-10.37 34.978c2.913 0 5.261-2.37 5.261-5.282c0-2.044-1.152-3.718-2.826-4.631c-.696-.37-.935-.63-.935-1.696V17.218c0-1.13-.652-1.827-1.5-1.827c-.826 0-1.5.696-1.5 1.827v21.086c0 1.066-.239 1.326-.934 1.696c-1.674.913-2.827 2.587-2.827 4.63a5.256 5.256 0 0 0 5.261 5.283M43.17 24.348h4.718c.978 0 1.782-.826 1.782-1.804c0-1-.804-1.805-1.782-1.805H43.17c-.956 0-1.783.805-1.783 1.805c0 .978.827 1.804 1.783 1.804M40.605 38.5c.696.696 1.826.674 2.522-.022c.695-.695.695-1.848 0-2.521l-3.348-3.348c-.696-.674-1.848-.696-2.544 0a1.81 1.81 0 0 0 0 2.543Z"
        />
      </svg>
    </div>
  );
}

export function CloudDrizzleIcon() {
  return (
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="6em"
      height="6em"
      viewBox="0 0 40 40"
    >
      <path
        fill="currentColor"
        d="M15.201 30.464a.466.466 0 0 1-.172-.033a151.637 151.637 0 0 1-3.912-.056c-.943-.023-1.818-.044-2.831-.044a6.005 6.005 0 0 1-5.999-5.998c0-2.004.97-3.832 2.611-4.951a9.885 9.885 0 0 1-.202-1.989c0-5.435 4.422-9.858 9.859-9.858a9.88 9.88 0 0 1 8.684 5.186a5.948 5.948 0 0 1 4.279-1.795a6.005 6.005 0 0 1 5.823 7.452a6.002 6.002 0 0 1 4.372 5.775c0 3.308-2.691 6-5.999 6c-1.542 0-5.043.08-8.428.158c-3.417.08-6.644.153-8.085.153m-.646-21.998c-4.923 0-8.928 4.004-8.928 8.927c0 .707.084 1.412.249 2.095a.465.465 0 0 1-.212.507a5.033 5.033 0 0 0-2.447 4.338A5.073 5.073 0 0 0 8.285 29.4c1.021 0 1.903.021 2.854.044c1.105.026 2.304.055 3.93.055a.47.47 0 0 1 .172.033c1.453-.002 4.792-.078 8.022-.152c3.391-.078 6.897-.158 8.45-.158a5.074 5.074 0 0 0 5.068-5.069a5.066 5.066 0 0 0-4.114-4.977a.464.464 0 0 1-.352-.607a5.073 5.073 0 0 0-4.797-6.711a5.036 5.036 0 0 0-4.018 1.981a.463.463 0 0 1-.793-.094a8.949 8.949 0 0 0-8.152-5.279"
      />
      <path
        fill="currentColor"
        d="M17.858 21.514a.15.15 0 0 1 .117.055l.323.348a2.573 2.573 0 0 1-.894.665c-.35.159-.773.238-1.27.238c-.43 0-.82-.075-1.172-.224a2.558 2.558 0 0 1-.9-.628a2.817 2.817 0 0 1-.578-.97a3.634 3.634 0 0 1-.205-1.243c0-.452.072-.867.214-1.244a2.705 2.705 0 0 1 1.529-1.602a3.095 3.095 0 0 1 1.193-.223c.427 0 .804.069 1.131.205c.326.136.613.322.862.556l-.268.373a.215.215 0 0 1-.065.069a.19.19 0 0 1-.107.027c-.05 0-.112-.027-.184-.082a2.239 2.239 0 0 0-.724-.365a2.2 2.2 0 0 0-.649-.082c-.31 0-.593.055-.851.162a1.846 1.846 0 0 0-.663.467c-.185.203-.33.452-.433.745a2.977 2.977 0 0 0-.154.992c0 .374.054.707.161 1c.107.293.254.541.44.743s.404.357.657.463c.253.106.526.159.819.159c.179 0 .34-.01.483-.032a1.9 1.9 0 0 0 .398-.098a1.65 1.65 0 0 0 .339-.169c.105-.069.209-.151.313-.245a.21.21 0 0 1 .138-.06m6.809-1.758c0 .449-.071.861-.214 1.238a2.852 2.852 0 0 1-.603.969a2.692 2.692 0 0 1-.935.631a3.161 3.161 0 0 1-1.208.223c-.441 0-.843-.074-1.206-.223a2.684 2.684 0 0 1-.933-.631a2.827 2.827 0 0 1-.603-.969a3.457 3.457 0 0 1-.214-1.238c0-.45.071-.862.214-1.238c.143-.375.344-.7.603-.971a2.7 2.7 0 0 1 .933-.634a3.107 3.107 0 0 1 1.206-.226c.442 0 .844.075 1.208.226c.363.15.676.363.935.634c.26.272.461.596.603.971c.143.376.214.788.214 1.238m-.834 0c0-.369-.05-.7-.151-.992a2.089 2.089 0 0 0-.427-.743a1.85 1.85 0 0 0-.67-.467a2.277 2.277 0 0 0-.88-.164c-.321 0-.612.055-.875.164a1.853 1.853 0 0 0-.671.467c-.186.202-.329.45-.43.743c-.1.293-.151.623-.151.992c0 .368.051.698.151.99c.101.291.243.538.43.741c.185.203.409.357.671.464c.263.108.554.162.875.162c.323 0 .617-.054.88-.162c.262-.107.485-.262.67-.464c.185-.203.326-.45.427-.741c.102-.292.151-.622.151-.99m3.636 5.374c.047 0 .085.014.113.042a.148.148 0 0 1 .042.107v.264H25.29v-.149a.27.27 0 0 1 .08-.186l1.12-1.125c.093-.095.177-.185.254-.273c.076-.087.141-.174.195-.263c.054-.088.094-.177.124-.267a.937.937 0 0 0 .044-.29a.68.68 0 0 0-.049-.269a.516.516 0 0 0-.332-.306a.79.79 0 0 0-.493.002a.648.648 0 0 0-.344.273a.688.688 0 0 0-.083.21c-.019.057-.046.095-.079.114c-.034.019-.08.024-.141.016l-.227-.04c.023-.159.067-.3.134-.423c.065-.122.149-.225.249-.309c.1-.082.214-.145.342-.189c.129-.043.268-.064.418-.064c.148 0 .286.022.414.065a.903.903 0 0 1 .557.498a.99.99 0 0 1 .08.41c0 .13-.019.252-.058.362a1.43 1.43 0 0 1-.158.318c-.067.102-.144.2-.231.296c-.087.096-.18.193-.277.291l-.923.941c.065-.017.131-.032.198-.042c.066-.011.131-.016.193-.016h1.172z"
      />
    </svg>
  );
}

function ColdWaterIcon() {
  return (
    <div className="h-[96px] flex items-center">
      <svg
        width="5em"
        height="5em"
        version="1.1"
        id="Layer_1"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 262.759 262.759"
        fill="#000000"
      >
        <g></g>
        <g id="SVGRepo_tracerCarrier"></g>
        <g id="SVGRepo_iconCarrier">
          {" "}
          <g>
            {" "}
            <g>
              {" "}
              <g>
                {" "}
                <g id="XMLID_23_">
                  {" "}
                  <g>
                    {" "}
                    <g>
                      {" "}
                      <path
                        fill="#2D213F"
                        d="M210.747,75.576c43.704,42.742,43.704,112.303-0.032,155.046 c-21.179,20.73-49.343,32.137-79.301,32.137s-58.122-11.407-79.333-32.137c-21.179-20.698-32.842-48.253-32.842-77.539 s11.663-56.84,32.842-77.539l73.406-73.213c3.14-3.108,8.715-3.108,11.823,0L210.747,75.576z M199.021,219.186 c37.296-36.43,37.296-95.77,0-132.2c0-0.032-0.032-0.032-0.064-0.064l-67.542-67.35l-67.574,67.35 c-18.103,17.719-28.036,41.204-28.036,66.164s9.933,48.446,28.004,66.1c18.039,17.654,42.07,27.395,67.606,27.395 S180.95,236.841,199.021,219.186z"
                      ></path>{" "}
                    </g>{" "}
                    <g>
                      {" "}
                      <path
                        fill="#2D213F"
                        d="M189.12,88.011c1.25,1.089,30.407,27.459,24.031,70.49c-0.609,4.037-4.133,6.921-8.202,6.921 c-0.384,0-0.769-0.032-1.186-0.064c-4.518-0.641-7.658-4.774-6.985-9.164c5.127-34.604-18.52-55.975-18.744-56.2 c-3.396-2.98-3.653-8.106-0.609-11.407C180.501,85.256,185.724,84.999,189.12,88.011z"
                      ></path>{" "}
                    </g>{" "}
                    <g>
                      {" "}
                      <path
                        fill="#2D213F"
                        d="M203.57,171.667c3.845,2.403,4.998,7.401,2.531,11.15l-4.55,6.985 c-1.57,2.403-4.229,3.749-6.985,3.749c-1.506,0-3.044-0.417-4.422-1.282c-3.845-2.403-4.998-7.401-2.531-11.15l4.518-6.985 C194.599,170.353,199.725,169.264,203.57,171.667z"
                      ></path>{" "}
                    </g>{" "}
                    <g>
                      {" "}
                      <path
                        fill="#AAE1E9"
                        d="M199.021,86.983c37.296,36.43,37.296,95.77,0,132.2c-18.071,17.655-42.07,27.395-67.606,27.395 s-49.567-9.74-67.606-27.395c-18.071-17.654-28.004-41.14-28.004-66.1s9.933-48.446,28.036-66.164l67.574-67.35l67.542,67.35 C198.989,86.954,199.021,86.954,199.021,86.983z M213.15,158.498c6.376-43.031-22.781-69.4-24.031-70.49 c-3.396-3.012-8.619-2.756-11.695,0.577c-3.044,3.3-2.788,8.427,0.609,11.407c0.224,0.224,23.87,21.596,18.744,56.2 c-0.673,4.39,2.467,8.523,6.985,9.164c0.417,0.032,0.801,0.064,1.186,0.064C209.017,165.419,212.542,162.538,213.15,158.498z M206.102,182.817c2.467-3.749,1.314-8.747-2.531-11.15s-8.971-1.314-11.439,2.467l-4.518,6.985 c-2.467,3.749-1.314,8.747,2.531,11.15c1.378,0.865,2.916,1.282,4.422,1.282c2.756,0,5.415-1.346,6.985-3.749L206.102,182.817 z"
                      ></path>{" "}
                    </g>{" "}
                  </g>{" "}
                </g>{" "}
              </g>{" "}
              <path
                fill="#92C1CA"
                d="M47.602,108.05c-7.696,13.656-11.797,29.039-11.797,45.037c0,24.96,9.933,48.446,28.004,66.1 c18.039,17.654,42.07,27.395,67.606,27.395c20,0,39.042-5.998,55.046-17.071C77.357,235.803,49.209,163.769,47.602,108.05z"
              ></path>{" "}
            </g>{" "}
          </g>{" "}
        </g>
      </svg>
    </div>
  );
}

function WarmWaterIcon() {
  return (
    <div className="h-[96px] flex items-center">
      <svg
        width="5em"
        height="5em"
        version="1.1"
        id="Layer_1"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 262.759 262.759"
        fill="#000000"
      >
        <g id="SVGRepo_bgCarrier"></g>
        <g id="SVGRepo_tracerCarrier"></g>
        <g id="SVGRepo_iconCarrier">
          {" "}
          <g>
            {" "}
            <g>
              {" "}
              <g>
                {" "}
                <g id="XMLID_23_">
                  {" "}
                  <g>
                    {" "}
                    <g>
                      {" "}
                      <path
                        fill="#2D213F"
                        d="M210.747,75.576c43.704,42.742,43.704,112.303-0.032,155.046 c-21.179,20.73-49.343,32.137-79.301,32.137s-58.122-11.407-79.333-32.137c-21.179-20.698-32.842-48.253-32.842-77.539 s11.663-56.84,32.842-77.539l73.406-73.213c3.14-3.108,8.715-3.108,11.823,0L210.747,75.576z M199.021,219.186 c37.296-36.43,37.296-95.77,0-132.2c0-0.032-0.032-0.032-0.064-0.064l-67.542-67.35l-67.574,67.35 c-18.103,17.719-28.036,41.204-28.036,66.164s9.933,48.446,28.004,66.1c18.039,17.654,42.07,27.395,67.606,27.395 S180.95,236.841,199.021,219.186z"
                      ></path>{" "}
                    </g>{" "}
                    <g>
                      {" "}
                      <path
                        fill="#2D213F"
                        d="M189.12,88.011c1.25,1.089,30.407,27.459,24.031,70.49c-0.609,4.037-4.133,6.921-8.202,6.921 c-0.384,0-0.769-0.032-1.186-0.064c-4.518-0.641-7.658-4.774-6.985-9.164c5.127-34.604-18.52-55.975-18.744-56.2 c-3.396-2.98-3.653-8.106-0.609-11.407C180.501,85.256,185.724,84.999,189.12,88.011z"
                      ></path>{" "}
                    </g>{" "}
                    <g>
                      {" "}
                      <path
                        fill="#2D213F"
                        d="M203.57,171.667c3.845,2.403,4.998,7.401,2.531,11.15l-4.55,6.985 c-1.57,2.403-4.229,3.749-6.985,3.749c-1.506,0-3.044-0.417-4.422-1.282c-3.845-2.403-4.998-7.401-2.531-11.15l4.518-6.985 C194.599,170.353,199.725,169.264,203.57,171.667z"
                      ></path>{" "}
                    </g>{" "}
                    <g>
                      {" "}
                      <path
                        fill="#ff7373"
                        d="M199.021,86.983c37.296,36.43,37.296,95.77,0,132.2c-18.071,17.655-42.07,27.395-67.606,27.395 s-49.567-9.74-67.606-27.395c-18.071-17.654-28.004-41.14-28.004-66.1s9.933-48.446,28.036-66.164l67.574-67.35l67.542,67.35 C198.989,86.954,199.021,86.954,199.021,86.983z M213.15,158.498c6.376-43.031-22.781-69.4-24.031-70.49 c-3.396-3.012-8.619-2.756-11.695,0.577c-3.044,3.3-2.788,8.427,0.609,11.407c0.224,0.224,23.87,21.596,18.744,56.2 c-0.673,4.39,2.467,8.523,6.985,9.164c0.417,0.032,0.801,0.064,1.186,0.064C209.017,165.419,212.542,162.538,213.15,158.498z M206.102,182.817c2.467-3.749,1.314-8.747-2.531-11.15s-8.971-1.314-11.439,2.467l-4.518,6.985 c-2.467,3.749-1.314,8.747,2.531,11.15c1.378,0.865,2.916,1.282,4.422,1.282c2.756,0,5.415-1.346,6.985-3.749L206.102,182.817 z"
                      ></path>{" "}
                    </g>{" "}
                  </g>{" "}
                </g>{" "}
              </g>{" "}
              <path
                fill="#ff5e5e"
                d="M47.602,108.05c-7.696,13.656-11.797,29.039-11.797,45.037c0,24.96,9.933,48.446,28.004,66.1 c18.039,17.654,42.07,27.395,67.606,27.395c20,0,39.042-5.998,55.046-17.071C77.357,235.803,49.209,163.769,47.602,108.05z"
              ></path>{" "}
            </g>{" "}
          </g>{" "}
        </g>
      </svg>
    </div>
  );
}

// ... (CloudDrizzleIcon and ThermometerIcon components remain the same)
